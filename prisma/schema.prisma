generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// 1. ROLES & ENUMS
// ==========================================

enum Role {
  MASTER_ADMIN     // God mode
  DEPT_ADMIN       // Admin of a specific Department
  DEPT_USER        // Employee in a Department
  VIEW_ONLY_USER   // External or limited viewer
}

enum AuthProvider {
  CREDENTIALS
  AUTH0
  GOOGLE
}

enum Status {
  ACTIVE
  ARCHIVED
  UNVERIFIED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestType {
  CREATE_CATEGORY
  ACCESS_DOCUMENT
  OTHER
}

enum ActivityType {
  LOGIN
  UPLOAD_FILE
  DELETE_FILE
  CREATE_CATEGORY
  APPROVE_REQUEST
  REJECT_REQUEST
  SEND_MESSAGE
}

// This was missing previously!
enum AnalyticsEventType {
  VIEW
  DOWNLOAD
}

enum DocumentCategory {
  EXECUTIVE_OVERVIEW
  FOUNDERS_MANAGEMENT
  LEGAL
  CAP_TABLE
  FINANCIALS
  BUSINESS_PRODUCT
  REVENUE_CONTRACTS
  IP_TECHNOLOGY
  COMPLIANCE
  HUMAN_RESOURCES
  RISKS_LITIGATION
  OTHER
}

// ==========================================
// 2. CORE USER & AUTH
// ==========================================

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique @default(uuid())
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  resetAt   DateTime? @db.Timestamptz(6)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model User {
  id                String       @id @default(cuid())
  userId            String       @unique @default(uuid()) // Legacy field

  email             String       @unique @db.VarChar(320)
  firstName         String       @default("")
  lastName          String       @default("")
  password          String?
  avatarUrl         String?

  // -- Auth --
  role              Role         @default(VIEW_ONLY_USER)
  status            Status       @default(UNVERIFIED)
  authProvider      AuthProvider @default(CREDENTIALS)
  auth0Sub          String?      @unique
  verificationToken String?
  tokenExpiresAt    DateTime?

  // -- Department Logic --
  departmentId      String?
  department        Department?  @relation(fields: [departmentId], references: [id])

  // -- Granular Permissions --
  categoryAccess    UserCategoryAccess[]

  // -- Relations --
  documents         Document[]
  documentLinks     DocumentLink[]
  brandingSetting   BrandingSetting?
  passwordResetTokens PasswordResetToken[]

  // -- Requests Workflow --
  requestsMade      Request[]    @relation("UserRequests")
  requestsManaged   Request[]    @relation("UserApprovals")

  // -- Chat & Activity --
  messagesSent      Message[]
  activityLogs      ActivityLog[]

  createdAt         DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @db.Timestamptz(6)

  @@index([email])
  @@index([departmentId])
}

// ==========================================
// 3. ORGANIZATION STRUCTURE (New)
// ==========================================

model Department {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?

  users       User[]
  categories  Category[]
  chats       ChatChannel[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Category {
  id           String     @id @default(cuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  documents    Document[]
  accessList   UserCategoryAccess[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([name, departmentId])
}

// Join table for granular access
model UserCategoryAccess {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  canUpload  Boolean  @default(false)
  canDelete  Boolean  @default(false)

  @@unique([userId, categoryId])
}

// ==========================================
// 4. WORKFLOWS: REQUESTS & ACTIVITY
// ==========================================

model Request {
  id          String        @id @default(cuid())
  type        RequestType
  status      RequestStatus @default(PENDING)

  // Data payload (e.g. { "categoryName": "Invoices" })
  details     Json?

  requesterId String
  requester   User          @relation("UserRequests", fields: [requesterId], references: [id])

  approverId  String?
  approver    User?         @relation("UserApprovals", fields: [approverId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ActivityLog {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  action      ActivityType
  details     String
  metadata    Json?

  createdAt   DateTime     @default(now())
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// 5. DOCUMENTS (Updated)
// ==========================================

model Document {
  id          Int      @id @default(autoincrement())
  documentId  String   @unique @default(uuid())

  fileName    String
  filePath    String   @db.Text
  fileType    String
  size        Int

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Link to the new Category model
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])

  // Legacy Enum
  categoryEnum DocumentCategory @default(OTHER) @map("category")

  documentLinks DocumentLink[]
  analytics     DocumentAnalytics[]

  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@index([categoryId])
}

// ==========================================
// 6. CHAT SYSTEM (New)
// ==========================================

model ChatChannel {
  id           String     @id @default(cuid())
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  // If null, it's the general "Dept Room" chat. If set, it's a private chat for that viewer.
  viewerUserId String?

  messages     Message[]

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Message {
  id          String      @id @default(cuid())
  content     String      @db.Text

  senderId    String
  sender      User        @relation(fields: [senderId], references: [id])

  channelId   String
  channel     ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())
}

// ==========================================
// 7. EXTERNAL LINKS & ANALYTICS (Existing)
// ==========================================

model DocumentLink {
  id              Int      @id @default(autoincrement())
  documentLinkId  String   @unique
  documentId      String // Reference to Document.documentId (UUID)
  document        Document @relation(fields: [documentId], references: [documentId], onDelete: Cascade)

  createdByUserId String
  creator         User     @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)

  alias           String?
  isPublic        Boolean   @default(false)
  expirationTime  DateTime?
  password        String?
  visitorFields   Json

  visitors        DocumentLinkVisitor[]
  analytics       DocumentAnalytics[]

  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  @@unique([documentId, alias], name: "document_alias_unique")
  @@index([documentId])
  @@index([createdByUserId])
}

model DocumentLinkVisitor {
  id              Int      @id @default(autoincrement())
  documentLinkId  String
  documentLink    DocumentLink @relation(fields: [documentLinkId], references: [documentLinkId], onDelete: Cascade)

  firstName       String   @default("")
  lastName        String   @default("")
  email           String   @default("") @db.VarChar(320)
  visitorMetaData Json?
  visitedAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)

  analytics       DocumentAnalytics[]

  @@index([documentLinkId, visitedAt])
}

model DocumentAnalytics {
  id             Int                @id @default(autoincrement())
  documentId     String
  document       Document           @relation(fields: [documentId], references: [documentId], onDelete: Cascade)

  documentLinkId String?
  documentLink   DocumentLink?      @relation(fields: [documentLinkId], references: [documentLinkId], onDelete: Cascade)

  visitorId      Int?
  visitor        DocumentLinkVisitor? @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  eventType      AnalyticsEventType
  meta           Json?
  timestamp      DateTime           @default(now()) @db.Timestamptz(6)
  minuteBucket   DateTime           @default(dbgenerated("date_trunc('minute', now())")) @db.Timestamptz(6)

  @@unique([visitorId, documentLinkId, eventType, minuteBucket])
  @@index([documentId, eventType])
  @@index([documentLinkId, eventType])
}

// ==========================================
// 8. SETTINGS (Existing)
// ==========================================

model BrandingSetting {
  userId           String       @id
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  logoUrl          String?
  displayName      String?
  primaryColor     String       @default("#1570EF")
  themePreset      ThemePreset?
  bgPreset         BgPreset     @default(plain)
  showPersonalInfo Boolean      @default(false)

  createdAt        DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime     @updatedAt @db.Timestamptz(6)
}

enum ThemePreset {
  lavender
  midnight
  aqua
  blossom
  graphite
  sunset
  mint
}

enum BgPreset {
  plain
  soft
  dark
}

model SystemSetting {
  id                 Int      @id @default(1)
  enableNotifications Boolean  @default(false)
  brevoApiKeyEnc      String?
  emailFromName       String?
  emailFromAddr       String?
  defaultTtlSeconds   Int      @default(86400)
  debugLogs           Boolean  @default(false)
  maxFileSizeMb       Int?
  allowedMimeTypes    String?

  createdAt           DateTime @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @db.Timestamptz(6)
}